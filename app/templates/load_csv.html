{% extends 'base.html' %}

{% block title %}
    Загрузка CSV файла
{% endblock %}

{% block content %}
    <div class="container">
        <div class="upload-form">
            <h2>Загрузка и анализ CSV</h2>
            <form id="upload-form" enctype="multipart/form-data">
                <div class="form-group">
                    <label for="file">Выберите CSV файл:</label>
                    <input type="file" class="form-control-file" id="file" name="file">
                </div>
                <p></p>
                <button type="button" class="btn btn-primary" id="upload-button">Загрузить файл</button>
                <p></p>
            </form>
            <div class="messages" id="messages">
                {% if error %}
                    <div class="alert alert-danger">{{ error }}</div>
                {% endif %}
            </div>
        </div>

        <div class="report-section" style="margin-top: 20px; display: flex; justify-content: space-between; align-items: center;">
            <button class="btn btn-success" id="generate-report-button" style="display: none;">Произвести анализ данных</button>
            <form action="{{ url_for('main.download_report') }}" method="GET">
                <button class="btn btn-success" id="generate-report-excel-button" style="display: none;" type="submit">Сформировать отчет в MS Excel</button>
            </form>


        </div>

        <div class="progress" style="margin-top: 10px; display: none;" id="progress-bar-container">
            <div class="progress-bar" id="progress-bar" role="progressbar" style="width: 0%;" aria-valuenow="0"
                 aria-valuemin="0" aria-valuemax="100">0%
            </div>
        </div>

        <div class="graph-container" style="margin-top: 20px;">
            {% if metrics %}
                <center><h2>Метрики</h2></center>
                <table class="table table-striped table-bordered mx-auto" style="width: 50%;">
                    <thead>
                    <tr>
                        <th class="text-center">Название метрики</th>
                        <th class="text-center">Значение</th>
                    </tr>
                    </thead>
                    <tbody>
                        {% for metric_name, metric_data in metrics.items() %}
                            <tr class="text-center">
                                <td>{{ metric_data.name_ru }}</td>
                                <td>
                                    {% if metric_data.value is integer %}
                                        {{ "{:,}".format(metric_data.value).replace(",", " ") }}  <!-- Целые-->
                                    {% else %}
                                        {{ "{:,.2f}".format(metric_data.value).replace(",", " ") }}  <!-- Дробные -->
                                    {% endif %}
                                </td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            {% endif %}


            <div class="col-md-3">
                <select class="form-control" id="graph-selector" style="display: none;" onchange="updateGraphs()">
                    <option value="all">Показать все</option>
                    {% for title, graph in graphs.items() %}
                        <option value="{{ title }}">{{ title }}</option>
                    {% endfor %}
                </select>
            </div>
            {% for title, graph in graphs.items() %}
                <div class="single-graph" data-graph="{{ title }}">
                    <center><h2>{{ title }}</h2></center>
                    {{ graph|safe }}
                </div>
            {% endfor %}


        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <script>

        {##########---фильтрация---##########}
        function updateGraphs() {
            const selectedGraph = document.getElementById("graph-selector").value;
            const graphs = document.querySelectorAll(".single-graph");

            graphs.forEach(graph => {
                graph.style.display = (selectedGraph === "all" || graph.dataset.graph === selectedGraph) ? "block" : "none";
            });
        }

        document.addEventListener("DOMContentLoaded", () => {
            const graphs = document.querySelectorAll(".single-graph");
            graphs.forEach(graph => graph.style.display = "none");
            document.querySelector('#graph-selector').dispatchEvent(new Event('change'));
        });
        {#####################################}

        {#########################################}
        $(document).ready(function () {
            // Скрываем кнопку при загрузке страницы
            $('#upload-button').hide();

            // Обработчик изменения для input[type="file"]
            $('#file').on('change', function () {
                if (this.files.length > 0) {
                    $('#upload-button').show();
                } else {
                    $('#upload-button').hide();
                }

                // Сбрасываем сообщения и состояние графиков перед новым выбором файла
                $('#messages').empty();
                $('.graph-container').empty();
                $('#generate-report-button').hide();
                $('#generate-report-excel-button').hide();
            });

            // Обработчик клика на кнопку загрузки
            $('#upload-button').on('click', function () {
                var file_data = $('#file').prop('files')[0];
                var form_data = new FormData();
                form_data.append('file', file_data);

                $.ajax({
                    url: '/upload',
                    type: 'POST',
                    dataType: 'json',
                    contentType: false,
                    processData: false,
                    data: form_data,
                    success: function (response) {
                        $('#messages').html('<div class="alert alert-' + (response.status === 'success' ? 'success' : 'danger') + '">' + response.message + '</div>');

                        // Показываем кнопки только при успешной загрузке
                        if (response.status === 'success') {
                            $('#generate-report-button').show();
                            {#$('#generate-report-excel-button').show();#}
                        } else {
                            // Скрываем кнопки, если загрузка была неудачной
                            $('#generate-report-button').hide();
                            $('#generate-report-excel-button').hide();
                        }
                    },
                    error: function (xhr) {
                        $('#messages').html('<div class="alert alert-danger">Произошла ошибка при загрузке файла.</div>');
                        // Скрываем кнопки в случае ошибки
                        $('#generate-report-button').hide();
                        $('#generate-report-excel-button').hide();
                    }
                });
            });
        });
        {#################################################################}

        $(document).ready(function () {

            {##########---сокрытие кнопки загрузить файл---##########}
            // Скрываем кнопку при загрузке страницы
            document.getElementById('upload-button').style.display = 'none';

            // Обработчик изменения для input[type="file"]
            document.getElementById('file').addEventListener('change', function () {
                // Если файл выбран, показываем кнопку
                if (this.files.length > 0) {
                    document.getElementById('upload-button').style.display = 'block';
                } else {
                    document.getElementById('upload-button').style.display = 'none'; // Если файл не выбран, скрываем кнопку
                }
            });
            {#########################################################}


            // Генерация отчета
            $('#generate-report-button').on('click', function () {
                // Показываем индикатор выполнения
                $('#progress-bar-container').show();
                $('#progress-bar').width('0%').text('0%');

                // Подключаемся к SSE для отслеживания прогресса
                var source = new EventSource('/progress');

                source.onmessage = function (event) {
                    var progress = parseInt(event.data);
                    $('#progress-bar').width(progress + '%').text(progress + '%');

                    if (progress === 100) {
                        source.close(); // Закрываем соединение после завершения

                        // Загружаем метрики и графики
                        $.ajax({
                            url: '/generate_report',
                            type: 'POST',
                            success: function (response) {
                                $('.graph-container').html($(response).find('.graph-container').html());
                                $('#graph-selector').show();


                                $('.dropdown-toggle').dropdown();
                                $('#dropdown-container').show();
                                $('#progress-bar-container').hide();
                                $('#dropdown-container').show();
                                $('#generate-report-excel-button').show();

                            },
                            error: function (xhr, status, error) {
                                $('#messages').html('<div class="alert alert-danger">Произошла ошибка при формировании отчета.</div>');
                                $('#generate-report-button').hide();
                                $('#generate-report-excel-button').hide();
                                $('#progress-bar-container').hide();
                            }
                        });
                    }
                };

                source.onerror = function (error) {
                    console.error("SSE error:", error);
                    source.close();
                    $('#messages').html('<div class="alert alert-danger">Ошибка подключения к потоку прогресса.</div>');
                    // Скрываем кнопки в случае ошибки
                    $('#generate-report-button').hide();
                    $('#generate-report-excel-button').hide();
                    $('#progress-bar-container').hide();
                };
            });
        });
    </script>
{% endblock %}